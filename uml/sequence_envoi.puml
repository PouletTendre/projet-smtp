@startuml sequence_envoi_mail

title Sequence d'envoi d'un mail

actor "Utilisateur" as user
participant "SMTPClient" as client
participant "SMTPServer" as server
participant "SMTPSession" as session
participant "SMTPHandler" as handler
participant "Mailbox" as mailbox

user -> client : send_mail(sender, recipient, subject, body)
activate client

client -> server : connect()
activate server
server -> session : new SMTPSession(socket, address)
activate session
session -> handler : new SMTPHandler()
activate handler
handler -> mailbox : new Mailbox()
activate mailbox

session --> client : 220 Serveur SMTP pret

client -> session : HELO localhost
session -> handler : handle_command("HELO localhost")
handler --> session : 250 OK
session --> client : 250 OK

client -> session : MAIL FROM:<sender>
session -> handler : handle_command("MAIL FROM:<sender>")
handler --> session : 250 OK
session --> client : 250 OK

client -> session : RCPT TO:<recipient>
session -> handler : handle_command("RCPT TO:<recipient>")
handler --> session : 250 OK
session --> client : 250 OK

client -> session : DATA
session -> handler : handle_command("DATA")
handler --> session : 354 Entrez le message
session --> client : 354 Entrez le message

client -> session : [contenu du mail]
client -> session : .
session -> handler : handle_data_content(".")
handler -> mailbox : save_message(sender, recipient, data)
mailbox --> handler : OK
handler --> session : 250 Message accepte
session --> client : 250 Message accepte

client -> session : QUIT
session -> handler : handle_command("QUIT")
handler --> session : 221 Au revoir
session --> client : 221 Au revoir

client --> user : True

deactivate mailbox
deactivate handler
deactivate session
deactivate server
deactivate client

@enduml
